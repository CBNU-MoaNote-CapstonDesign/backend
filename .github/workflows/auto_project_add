name: Add Issue to Project (If Maintainer or Admin)

on:
  issues:
    types: [opened]

permissions:
  issues: read
  contents: read
  pull-requests: read
  repository-projects: write

jobs:
  check-and-add:
    runs-on: ubuntu-latest
    steps:
      - name: Check if issue author is a repository collaborator
        id: check_user
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.sender.login;
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username,
              });

              const permission = data.permission;
              core.info(`User ${username} has permission: ${permission}`);
              if (permission === 'admin' || permission === 'maintain') {
                core.setOutput("is_member", "true");
              } else {
                core.setOutput("is_member", "false");
              }
            } catch (error) {
              core.warning(`Failed to check permission: ${error.message}`);
              core.setOutput("is_member", "false");
            }

      - name: Add issue to Sprint project
        if: steps.check_user.outputs.is_member == 'true'
        uses: actions/add-to-project@v1
        with:
          project-url: https://github.com/orgs/CBNU-MoaNote-CapstonDesign/projects/12
          github-token: ${{ secrets.GITHUB_TOKEN }}
          status: Sub-Tasks
          
      - name: Add issue to backend project as Todo
        if: steps.check_user.outputs.is_member == 'true'
        uses: actions/add-to-project@v1
        with:
          project-url: https://github.com/orgs/CBNU-MoaNote-CapstonDesign/projects/4
          github-token: ${{ secrets.GITHUB_TOKEN }}
          status: Todo
